name: Integration Tests

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read

env:
  # Disable Husky git hooks (for local dev only)
  # https://typicode.github.io/husky/how-to.html#ci-server-and-docker
  HUSKY: '0'

jobs:
  integration-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - test-name: 'simple-feature-bump'
            test-start-version-string: 'v1.0.0'
            test-commit-list: |
              feat: add new feature (#80)
            expected-version-string: '1.1.0'
            expected-body: |
              ## Features

              * Add new feature (#80)
            template: |
              $CHANGES
            change-template: '* $TITLE (#$NUMBER)'
            category-template: '## $TITLE'
            categories: |
              - title: Features
                commit-types:
                  - feat

          - test-name: 'breaking-change-pre-1.0'
            test-start-version-string: 'v0.9.0'
            test-commit-list: |
              feat!: breaking change in pre-1.0 (#81)
            expected-version-string: '0.10.0'
            expected-body: |
              ## Features

              * Breaking change in pre-1.0 (#81)
            template: |
              $CHANGES
            change-template: '* $TITLE (#$NUMBER)'
            category-template: '## $TITLE'
            categories: |
              - title: Features
                commit-types:
                  - feat

          - test-name: 'breaking-change-post-1.0'
            test-start-version-string: 'v1.0.0'
            test-commit-list: |
              feat!: breaking change in post-1.0 (#85)
            expected-version-string: '2.0.0'
            expected-body: |
              ## Breaking Changes

              * Breaking change in post-1.0 (#85)
            template: |
              $CHANGES
            change-template: '* $TITLE (#$NUMBER)'
            category-template: '## $TITLE'
            categories: |
              - title: Breaking Changes
                commit-types:
                  - breaking
            # Opt-in to major version bumps for this test
            allow-major-bumps: true

          # Test default behavior: breaking change post-1.0 WITHOUT allow-major-bumps
          # should result in minor bump (marketing-aware semver)
          - test-name: 'breaking-change-post-1.0-default'
            test-start-version-string: 'v1.0.0'
            test-commit-list: |
              feat!: breaking change with default settings (#86)
            expected-version-string: '1.1.0'
            expected-body: |
              ## Breaking Changes

              * Breaking change with default settings (#86)
            template: |
              $CHANGES
            change-template: '* $TITLE (#$NUMBER)'
            category-template: '## $TITLE'
            categories: |
              - title: Breaking Changes
                commit-types:
                  - breaking
            # No allow-major-bumps set - tests the default behavior (minor bump)

          - test-name: 'multiple-commits-minor-bump'
            test-start-version-string: 'v2.0.0'
            test-commit-list: |
              fix: fix a bug (#82)
              feat: add another feature (#83)
              docs: update documentation (#84)
            expected-version-string: '2.1.0'
            expected-body: |
              ## Features

              * Add another feature (#83)

              ## Bug Fixes

              * Fix a bug (#82)

              ## Documentation

              * Update documentation (#84)
            template: |
              $CHANGES
            change-template: '* $TITLE (#$NUMBER)'
            category-template: '## $TITLE'
            categories: |
              - title: Features
                commit-types:
                  - feat
              - title: Bug Fixes
                commit-types:
                  - fix
              - title: Documentation
                commit-types:
                  - docs

          # Test zero-config mode (no inputs, pure defaults)
          # This verifies the action works with built-in defaults when no config is provided
          - test-name: 'zero-config-defaults'
            test-start-version-string: 'v1.0.0'
            test-commit-list: |
              feat: add new feature (#100)
              fix: fix a bug (#101)
            expected-version-string: '1.1.0'
            expected-body: |
              ## ‚ú® New Features

              * Add new feature (https://github.com/aaronsteers/semantic-pr-release-drafter/pull/100) 

              ## üêõ Bug Fixes

              * Fix a bug (https://github.com/aaronsteers/semantic-pr-release-drafter/pull/101)

              ---

              **Full Changelog**: https://github.com/aaronsteers/semantic-pr-release-drafter/compare/v1.0.0...v1.1.0
            # No template, change-template, category-template, or categories provided
            # This tests the zero-config path

          # Test collapse-after feature: when item count exceeds threshold, ALL items are collapsed
          # Note: commits are processed in reverse chronological order (newest first)
          - test-name: 'collapse-after-feature'
            test-start-version-string: 'v1.0.0'
            test-commit-list: |
              chore: update deps (#200)
              chore: cleanup code (#201)
              chore: fix typo (#202)
              chore: bump version (#203)
            expected-version-string: '1.0.1'
            expected-body: |
              ## Under the Hood

              <details>
              <summary>4 changes</summary>

              * Bump version (#203)
              * Fix typo (#202)
              * Cleanup code (#201)
              * Update deps (#200)
              </details>
            template: |
              $CHANGES
            change-template: '* $TITLE (#$NUMBER)'
            category-template: '## $TITLE'
            categories: |
              - title: Under the Hood
                commit-types:
                  - chore
                collapse-after: 2

          # Test that custom emoji category titles are used instead of defaults
          - test-name: 'custom-emoji-categories'
            test-start-version-string: 'v1.0.0'
            test-commit-list: |
              feat: add cool feature (#90)
              fix: squash a bug (#91)
              chore: update deps (#92)
            expected-version-string: '1.1.0'
            expected-body: |
              ## New Features

              * Add cool feature (#90)

              ## Bug Fixes

              * Squash a bug (#91)

              ## Under the Hood

              * Update deps (#92)
            template: |
              $CHANGES
            change-template: '* $TITLE (#$NUMBER)'
            category-template: '## $TITLE'
            categories: |
              - title: New Features
                commit-types:
                  - feat
              - title: Bug Fixes
                commit-types:
                  - fix
              - title: Under the Hood
                commit-types:
                  - chore

          # Test scope-based categories with AND logic
          # When both commit-scopes and commit-types are specified, they are ANDed
          - test-name: 'scope-based-categories'
            test-start-version-string: 'v1.0.0'
            test-commit-list: |
              feat(sentry): add sentry monitoring (#400)
              fix(sentry): fix sentry alert (#401)
              feat: add other feature (#402)
              fix: fix other bug (#403)
            expected-version-string: '1.1.0'
            expected-body: |
              ## Sentry Features

              * Add sentry monitoring (#400)

              ## Sentry Updates

              * Fix sentry alert (#401)

              ## Features

              * Add other feature (#402)

              ## Bug Fixes

              * Fix other bug (#403)
            template: |
              $CHANGES
            change-template: '* $TITLE (#$NUMBER)'
            category-template: '## $TITLE'
            categories: |
              - title: Sentry Features
                commit-scopes:
                  - sentry
                commit-types:
                  - feat
              - title: Sentry Updates
                commit-scopes:
                  - sentry
              - title: Features
                commit-types:
                  - feat
              - title: Bug Fixes
                commit-types:
                  - fix

          # Test attach-files feature in dry-run mode
          # Verifies that file patterns are resolved and reported correctly
          - test-name: 'attach-files-dry-run'
            test-start-version-string: 'v1.0.0'
            test-commit-list: |
              feat: add build artifacts (#300)
            expected-version-string: '1.1.0'
            expected-body: |
              ## Features

              * Add build artifacts (#300)
            template: |
              $CHANGES
            change-template: '* $TITLE (#$NUMBER)'
            category-template: '## $TITLE'
            categories: |
              - title: Features
                commit-types:
                  - feat
            # Flag to indicate this test needs attach-files setup
            needs-attach-files: true

          # Test attach-files failure when no files match the pattern
          # Verifies that the action fails with a clear error message
          - test-name: 'attach-files-no-match-fails'
            test-start-version-string: 'v1.0.0'
            test-commit-list: |
              feat: add feature (#301)
            expected-version-string: '1.1.0'
            expected-body: |
              ## Features

              * Add feature (#301)
            template: |
              $CHANGES
            change-template: '* $TITLE (#$NUMBER)'
            category-template: '## $TITLE'
            categories: |
              - title: Features
                commit-types:
                  - feat
            # This test expects failure - no files will match
            attach-files-expect-failure: true

    name: ${{ matrix.test-name }}
    steps:
      - name: Checkout action code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create test repository
        run: |
          # Create a temporary directory for the test repo
          TEST_REPO=$(mktemp -d)
          echo "TEST_REPO=$TEST_REPO" >> $GITHUB_ENV

          cd "$TEST_REPO"
          git init
          git config user.email "test@example.com"
          git config user.name "TestUser"

          # Create initial commit
          echo "# Test Repo" > README.md
          git add README.md
          git commit -m "chore: initial commit"

          # Create initial tag
          git tag "${{ matrix.test-start-version-string }}"

          # Apply each commit from the list
          COMMIT_NUM=0
          while IFS= read -r commit_msg; do
            # Skip empty lines
            if [ -z "$commit_msg" ]; then
              continue
            fi
            COMMIT_NUM=$((COMMIT_NUM + 1))
            echo "Change $COMMIT_NUM" >> README.md
            git add README.md
            git commit -m "$commit_msg"
          done <<< "${{ matrix.test-commit-list }}"

          # Create .github directory (required for local-git-root)
          mkdir -p .github

      - name: Create test files for attach-files test
        if: matrix.needs-attach-files == true
        run: |
          cd "$TEST_REPO"
          mkdir -p dist
          echo "test content 1" > dist/file1.txt
          echo "test content 2" > dist/file2.txt
          echo "wheel content" > dist/app-1.0.0.whl
          echo "Files created for attach-files test:"
          ls -la dist/
          # Set attach-files patterns with absolute paths
          echo "ATTACH_FILES_PATTERNS<<EOF" >> $GITHUB_ENV
          echo "$TEST_REPO/dist/*.txt" >> $GITHUB_ENV
          echo "$TEST_REPO/dist/*.whl" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Set up attach-files failure test
        if: matrix.attach-files-expect-failure == true
        run: |
          # Set a pattern that won't match any files (no files created)
          echo "ATTACH_FILES_PATTERNS=$TEST_REPO/nonexistent/*.whl" >> $GITHUB_ENV

      - name: Run release-drafter in dry-run mode
        id: release-drafter
        if: matrix.attach-files-expect-failure != true
        uses: ./
        with:
          dry-run: 'true'
          local-git-root: ${{ env.TEST_REPO }}
          base-ref-override: ${{ matrix.test-start-version-string }}
          template: ${{ matrix.template }}
          change-template: ${{ matrix.change-template }}
          category-template: ${{ matrix.category-template }}
          categories: ${{ matrix.categories }}
          attach-files: ${{ env.ATTACH_FILES_PATTERNS }}
          allow-major-bumps: ${{ matrix.allow-major-bumps }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF: refs/heads/main

      - name: Run release-drafter expecting failure
        id: release-drafter-failure
        if: matrix.attach-files-expect-failure == true
        uses: ./
        continue-on-error: true
        with:
          dry-run: 'true'
          local-git-root: ${{ env.TEST_REPO }}
          base-ref-override: ${{ matrix.test-start-version-string }}
          template: ${{ matrix.template }}
          change-template: ${{ matrix.change-template }}
          category-template: ${{ matrix.category-template }}
          categories: ${{ matrix.categories }}
          attach-files: ${{ env.ATTACH_FILES_PATTERNS }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF: refs/heads/main

      - name: Verify attach-files failure
        if: matrix.attach-files-expect-failure == true
        run: |
          # With continue-on-error: true, outcome reflects the actual result before continue-on-error is applied
          if [ "${{ steps.release-drafter-failure.outcome }}" != "failure" ]; then
            echo "::error::Expected release-drafter to fail when no files match attach-files pattern, but it succeeded"
            exit 1
          fi
          echo "Correctly failed when no files matched attach-files pattern"

      - name: Verify resolved version
        if: matrix.attach-files-expect-failure != true
        run: |
          RESOLVED_VERSION="${{ steps.release-drafter.outputs.resolved-version }}"
          EXPECTED_VERSION="${{ matrix.expected-version-string }}"

          echo "Resolved version: $RESOLVED_VERSION"
          echo "Expected version: $EXPECTED_VERSION"

          if [ "$RESOLVED_VERSION" != "$EXPECTED_VERSION" ]; then
            echo "::error::Version mismatch! Expected $EXPECTED_VERSION but got $RESOLVED_VERSION"
            exit 1
          fi

          echo "Version check passed!"

      - name: Verify changelog body matches expected output
        if: matrix.attach-files-expect-failure != true
        run: |
          BODY="${{ steps.release-drafter.outputs.body }}"
          EXPECTED_BODY=$(cat << 'EXPECTED_EOF'
          ${{ matrix.expected-body }}
          EXPECTED_EOF
          )

          # Normalize whitespace for comparison (trim leading/trailing, normalize newlines)
          BODY_NORMALIZED=$(echo "$BODY" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | tr -s '\n')
          EXPECTED_NORMALIZED=$(echo "$EXPECTED_BODY" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | tr -s '\n')

          echo "=== Actual changelog body ==="
          echo "$BODY"
          echo ""
          echo "=== Expected changelog body ==="
          echo "$EXPECTED_BODY"
          echo ""

          if [ "$BODY_NORMALIZED" != "$EXPECTED_NORMALIZED" ]; then
            echo "::error::Changelog body does not match expected output"
            echo ""
            echo "=== Diff (expected vs actual) ==="
            diff <(echo "$EXPECTED_NORMALIZED") <(echo "$BODY_NORMALIZED") || true
            exit 1
          fi

          echo "Changelog body check passed!"
