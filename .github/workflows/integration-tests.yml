name: Integration Tests

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read

env:
  # Disable Husky git hooks (for local dev only)
  # https://typicode.github.io/husky/how-to.html#ci-server-and-docker
  HUSKY: '0'

jobs:
  integration-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - test-name: 'simple-feature-bump'
            test-start-version-string: 'v1.0.0'
            test-commit-list: |
              feat: add new feature (#80)
            expected-version-string: '1.1.0'
            expected-body: |
              ## Features

              * add new feature (#80)
            template: |
              $CHANGES
            change-template: '* $TITLE (#$NUMBER)'
            category-template: '## $TITLE'
            categories: |
              - title: Features
                commit-types:
                  - feat

          - test-name: 'breaking-change-pre-1.0'
            test-start-version-string: 'v0.9.0'
            test-commit-list: |
              feat!: breaking change in pre-1.0 (#81)
            expected-version-string: '0.10.0'
            expected-body: |
              ## Features

              * breaking change in pre-1.0 (#81)
            template: |
              $CHANGES
            change-template: '* $TITLE (#$NUMBER)'
            category-template: '## $TITLE'
            categories: |
              - title: Features
                commit-types:
                  - feat

          - test-name: 'breaking-change-post-1.0'
            test-start-version-string: 'v1.0.0'
            test-commit-list: |
              feat!: breaking change in post-1.0 (#85)
            expected-version-string: '2.0.0'
            expected-body: |
              ## Breaking Changes

              * breaking change in post-1.0 (#85)
            template: |
              $CHANGES
            change-template: '* $TITLE (#$NUMBER)'
            category-template: '## $TITLE'
            categories: |
              - title: Breaking Changes
                commit-types:
                  - breaking

          - test-name: 'multiple-commits-minor-bump'
            test-start-version-string: 'v2.0.0'
            test-commit-list: |
              fix: fix a bug (#82)
              feat: add another feature (#83)
              docs: update documentation (#84)
            expected-version-string: '2.1.0'
            expected-body: |
              ## Features

              * add another feature (#83)

              ## Bug Fixes

              * fix a bug (#82)

              ## Documentation

              * update documentation (#84)
            template: |
              $CHANGES
            change-template: '* $TITLE (#$NUMBER)'
            category-template: '## $TITLE'
            categories: |
              - title: Features
                commit-types:
                  - feat
              - title: Bug Fixes
                commit-types:
                  - fix
              - title: Documentation
                commit-types:
                  - docs

          # Test zero-config mode (no inputs, pure defaults)
          # This verifies the action works with built-in defaults when no config is provided
          - test-name: 'zero-config-defaults'
            test-start-version-string: 'v1.0.0'
            test-commit-list: |
              feat: add new feature (#100)
              fix: fix a bug (#101)
            expected-version-string: '1.1.0'
            expected-body: |
              ## ‚ú® New Features

              * add new feature (https://github.com/aaronsteers/semantic-pr-release-drafter/pull/100) 

              ## üêõ Bug Fixes

              * fix a bug (https://github.com/aaronsteers/semantic-pr-release-drafter/pull/101)

              ---

              **Full Changelog**: https://github.com/aaronsteers/semantic-pr-release-drafter/compare/v1.0.0...v1.1.0
            # No template, change-template, category-template, or categories provided
            # This tests the zero-config path

          # Test collapse-after feature: when item count exceeds threshold, ALL items are collapsed
          # Note: commits are processed in reverse chronological order (newest first)
          - test-name: 'collapse-after-feature'
            test-start-version-string: 'v1.0.0'
            test-commit-list: |
              chore: update deps (#200)
              chore: cleanup code (#201)
              chore: fix typo (#202)
              chore: bump version (#203)
            expected-version-string: '1.0.1'
            expected-body: |
              ## Under the Hood

              <details>
              <summary>4 changes</summary>

              * bump version (#203)
              * fix typo (#202)
              * cleanup code (#201)
              * update deps (#200)
              </details>
            template: |
              $CHANGES
            change-template: '* $TITLE (#$NUMBER)'
            category-template: '## $TITLE'
            categories: |
              - title: Under the Hood
                commit-types:
                  - chore
                collapse-after: 2

          # Test that custom emoji category titles are used instead of defaults
          - test-name: 'custom-emoji-categories'
            test-start-version-string: 'v1.0.0'
            test-commit-list: |
              feat: add cool feature (#90)
              fix: squash a bug (#91)
              chore: update deps (#92)
            expected-version-string: '1.1.0'
            expected-body: |
              ## New Features

              * add cool feature (#90)

              ## Bug Fixes

              * squash a bug (#91)

              ## Under the Hood

              * update deps (#92)
            template: |
              $CHANGES
            change-template: '* $TITLE (#$NUMBER)'
            category-template: '## $TITLE'
            categories: |
              - title: New Features
                commit-types:
                  - feat
              - title: Bug Fixes
                commit-types:
                  - fix
              - title: Under the Hood
                commit-types:
                  - chore

          # Test attach-files feature in dry-run mode
          # Verifies that file patterns are resolved and reported correctly
          - test-name: 'attach-files-dry-run'
            test-start-version-string: 'v1.0.0'
            test-commit-list: |
              feat: add build artifacts (#300)
            expected-version-string: '1.1.0'
            expected-body: |
              ## Features

              * add build artifacts (#300)
            template: |
              $CHANGES
            change-template: '* $TITLE (#$NUMBER)'
            category-template: '## $TITLE'
            categories: |
              - title: Features
                commit-types:
                  - feat
            # attach-files patterns to test glob resolution
            attach-files: |
              dist/*.txt
              dist/*.whl

    name: ${{ matrix.test-name }}
    steps:
      - name: Checkout action code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create test repository
        run: |
          # Create a temporary directory for the test repo
          TEST_REPO=$(mktemp -d)
          echo "TEST_REPO=$TEST_REPO" >> $GITHUB_ENV

          cd "$TEST_REPO"
          git init
          git config user.email "test@example.com"
          git config user.name "TestUser"

          # Create initial commit
          echo "# Test Repo" > README.md
          git add README.md
          git commit -m "chore: initial commit"

          # Create initial tag
          git tag "${{ matrix.test-start-version-string }}"

          # Apply each commit from the list
          COMMIT_NUM=0
          while IFS= read -r commit_msg; do
            # Skip empty lines
            if [ -z "$commit_msg" ]; then
              continue
            fi
            COMMIT_NUM=$((COMMIT_NUM + 1))
            echo "Change $COMMIT_NUM" >> README.md
            git add README.md
            git commit -m "$commit_msg"
          done <<< "${{ matrix.test-commit-list }}"

          # Create .github directory (required for local-git-root)
          mkdir -p .github

      - name: Create test files for attach-files test
        if: matrix.attach-files != ''
        run: |
          cd "$TEST_REPO"
          mkdir -p dist
          echo "test content 1" > dist/file1.txt
          echo "test content 2" > dist/file2.txt
          echo "wheel content" > dist/app-1.0.0.whl
          echo "Files created for attach-files test:"
          ls -la dist/

      - name: Run release-drafter in dry-run mode
        id: release-drafter
        uses: ./
        with:
          dry-run: 'true'
          local-git-root: ${{ env.TEST_REPO }}
          base-ref-override: ${{ matrix.test-start-version-string }}
          template: ${{ matrix.template }}
          change-template: ${{ matrix.change-template }}
          category-template: ${{ matrix.category-template }}
          categories: ${{ matrix.categories }}
          attach-files: ${{ matrix.attach-files }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF: refs/heads/main
          GITHUB_WORKSPACE: ${{ env.TEST_REPO }}

      - name: Verify resolved version
        run: |
          RESOLVED_VERSION="${{ steps.release-drafter.outputs.resolved_version }}"
          EXPECTED_VERSION="${{ matrix.expected-version-string }}"

          echo "Resolved version: $RESOLVED_VERSION"
          echo "Expected version: $EXPECTED_VERSION"

          if [ "$RESOLVED_VERSION" != "$EXPECTED_VERSION" ]; then
            echo "::error::Version mismatch! Expected $EXPECTED_VERSION but got $RESOLVED_VERSION"
            exit 1
          fi

          echo "Version check passed!"

      - name: Verify changelog body matches expected output
        run: |
          BODY="${{ steps.release-drafter.outputs.body }}"
          EXPECTED_BODY=$(cat << 'EXPECTED_EOF'
          ${{ matrix.expected-body }}
          EXPECTED_EOF
          )

          # Normalize whitespace for comparison (trim leading/trailing, normalize newlines)
          BODY_NORMALIZED=$(echo "$BODY" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | tr -s '\n')
          EXPECTED_NORMALIZED=$(echo "$EXPECTED_BODY" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | tr -s '\n')

          echo "=== Actual changelog body ==="
          echo "$BODY"
          echo ""
          echo "=== Expected changelog body ==="
          echo "$EXPECTED_BODY"
          echo ""

          if [ "$BODY_NORMALIZED" != "$EXPECTED_NORMALIZED" ]; then
            echo "::error::Changelog body does not match expected output"
            echo ""
            echo "=== Diff (expected vs actual) ==="
            diff <(echo "$EXPECTED_NORMALIZED") <(echo "$BODY_NORMALIZED") || true
            exit 1
          fi

          echo "Changelog body check passed!"
